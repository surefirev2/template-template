# OWNED BY template-template — do not edit. Changes will be overwritten on the next sync.
# Source: https://github.com/surefirev2/template-template
#
# Template Sync: on push to main, create a PR in each dependent (no direct push to main).
name: Template Sync

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no clone/push/PR)'
        required: false
        default: false
        type: boolean
      draft_pr:
        description: 'Create PRs as draft'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  template-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          # Need merge commit and both parents so "Generate diff" can run git diff HEAD^1 HEAD^2
          fetch-depth: ${{ github.event_name == 'pull_request' && 2 || 1 }}

      # Create token for push, workflow_dispatch, and pull_request (needed to open/update PRs in child repos)
      - name: Create GitHub App token
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Resolve dependent repos and exclusions
        id: config
        env:
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: bash .github/scripts/template-sync-resolve-config.sh --config .github/template-sync.yml --org "$GITHUB_REPOSITORY_OWNER" --out-dir .

      - name: Build list of files to sync
        id: files
        env:
          REPOS: ${{ steps.config.outputs.repos_list }}
        run: bash .github/scripts/template-sync-ga-build-file-list.sh

      # On push to main, detect merged PR so we use the same branch as the draft PRs and mark them ready (avoid duplicate PRs).
      - name: Get merged PR number (push to main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: merged-pr
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          pr=$(gh api "repos/${{ github.repository }}/commits/${{ github.sha }}/pulls" --jq '.[0].number' 2>/dev/null || true)
          if [[ -z "$pr" || "$pr" == "null" ]]; then
            # Fallback: parse default merge commit message "Merge pull request #N from ..."
            pr=$(git log -1 --pretty=%B "${{ github.sha }}" 2>/dev/null | sed -n 's/^Merge pull request #\([0-9]*\) from .*/\1/p' || true)
          fi
          if [[ -z "$pr" || "$pr" == "null" ]]; then
            # Fallback for squash merge: commit message often contains "(#N)" or " (#N)"
            pr=$(git log -1 --pretty=%B "${{ github.sha }}" 2>/dev/null | sed -n 's/.*(#\([0-9]*\)).*/\1/p' | head -1)
          fi
          if [[ -n "$pr" ]]; then
            echo "number=$pr" >> "$GITHUB_OUTPUT"
            echo "Merged PR number: $pr (will reuse draft PR branch)"
          else
            echo "number=" >> "$GITHUB_OUTPUT"
            echo "Not a merge of a PR; sync will use branch without PR suffix"
          fi

      - name: Preview sync impact
        if: github.event_name == 'pull_request'
        env:
          REPOS: ${{ steps.config.outputs.repos_list }}
          COUNT: ${{ steps.files.outputs.count }}
        run: bash .github/scripts/template-sync-write-step-summary.sh

      - name: Generate diff of synced files per repo (PR base → head)
        if: github.event_name == 'pull_request' && steps.files.outputs.count != '0' && steps.config.outputs.repos_list != ''
        env:
          REPOS: ${{ steps.config.outputs.repos_list }}
        run: bash .github/scripts/template-sync-generate-diffs.sh

      - name: Sync to dependents and open draft PR
        if: github.event_name == 'pull_request' && steps.config.outputs.repos_list != '' && steps.files.outputs.count != '0'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ORG: ${{ github.repository_owner }}
          BRANCH: chore/template-sync-${{ github.repository_owner }}-${{ github.event.repository.name }}
          PARENT_PR_NUMBER: ${{ github.event.pull_request.number }}
          PARENT_PR_URL: https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}
          REPOS_LIST: ${{ steps.config.outputs.repos_list }}
          FILES_LIST_TEMPLATE: files_to_sync_%s.txt
          DRAFT_PR: "1"
          CHILD_PR_URLS_FILE: child_pr_urls.txt
        run: bash .github/scripts/template-sync-push-pr.sh --draft

      - name: Upsert template sync preview comment on PR
        if: github.event_name == 'pull_request'
        env:
          DEBUG: "1"
          GH_TOKEN: ${{ github.token }}
          REPOS: ${{ steps.config.outputs.repos_list }}
          COUNT: ${{ steps.files.outputs.count }}
          FILES_LIST: files_to_sync.txt
          FILES_LIST_TEMPLATE: files_to_sync_%s.txt
          DIFF_FILE_TEMPLATE: sync_diff_%s.txt
          CHILD_PR_URLS_FILE: child_pr_urls.txt
        run: bash .github/scripts/template-sync-pr-comment.sh "${{ github.event.pull_request.number }}"

      - name: Sync to dependents and open PR
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.config.outputs.repos_list != '' && steps.files.outputs.count != '0'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ORG: ${{ github.repository_owner }}
          BRANCH: chore/template-sync-${{ github.repository_owner }}-${{ github.event.repository.name }}
          PARENT_PR_NUMBER: ${{ github.event_name == 'push' && steps.merged-pr.outputs.number || '' }}
          REPOS_LIST: ${{ steps.config.outputs.repos_list }}
          FILES_LIST_TEMPLATE: files_to_sync_%s.txt
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run && '1' || '' }}
          DRAFT_PR: ${{ github.event_name == 'workflow_dispatch' && inputs.draft_pr && '1' || '' }}
        run: bash .github/scripts/template-sync-push-pr.sh
