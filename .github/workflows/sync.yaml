# OWNED BY template-template — do not edit. Changes will be overwritten on the next sync.
# Source: https://github.com/surefirev2/template-template
#
# Template Sync: on push to main, create a PR in each dependent (no direct push to main).
name: Template Sync

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no clone/push/PR)'
        required: false
        default: false
        type: boolean
      draft_pr:
        description: 'Create PRs as draft'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  template-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Need merge commit and both parents so "Generate diff" can run git diff HEAD^1 HEAD^2
          fetch-depth: ${{ github.event_name == 'pull_request' && 2 || 1 }}

      # Create token for push and workflow_dispatch (needed for real sync; harmless for dry-run)
      - name: Create GitHub App token
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Resolve dependent repos and exclusions
        id: config
        env:
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: bash .github/scripts/template-sync-resolve-config.sh --config .github/template-sync.yml --org "$GITHUB_REPOSITORY_OWNER" --out-dir .

      - name: Build list of files to sync
        id: files
        run: |
          REPOS="${{ steps.config.outputs.repos_list }}"
          if [[ -n "$REPOS" ]]; then
            if [[ -s include_paths.txt ]]; then
              bash .github/scripts/template-sync-build-file-list.sh --repos "$REPOS" --include-file include_paths.txt --include-dir . --output-dir .
            else
              bash .github/scripts/template-sync-build-file-list.sh --repos "$REPOS" --exclusions-file exclusions.txt --include-dir . --output-dir .
            fi
          else
            if [[ -s include_paths.txt ]]; then
              bash .github/scripts/template-sync-build-file-list.sh --include-file include_paths.txt --output-dir .
            else
              bash .github/scripts/template-sync-build-file-list.sh --exclusions-file exclusions.txt --output-dir .
            fi
          fi

      - name: Preview sync impact
        if: github.event_name == 'pull_request'
        run: |
          echo "## Template sync preview" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          REPOS="${{ steps.config.outputs.repos_list }}"
          COUNT="${{ steps.files.outputs.count }}"
          echo "**Target repositories:** \`${REPOS:-none}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Files to sync:** $COUNT" >> "$GITHUB_STEP_SUMMARY"
          if [[ -f files_to_sync.txt && -s files_to_sync.txt ]]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "<details><summary>File list</summary>" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat files_to_sync.txt >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "</details>" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "*Actual sync runs only on push to \`main\`.*" >> "$GITHUB_STEP_SUMMARY"

      - name: Generate diff of synced files (PR base → head)
        if: github.event_name == 'pull_request' && steps.files.outputs.count != '0'
        run: |
          # Checkout yields merge commit: HEAD^1 = base, HEAD^2 = PR head (requires fetch-depth >= 2)
          FILES=$(tr '\n' ' ' < files_to_sync.txt)
          git diff HEAD^1 HEAD^2 -- $FILES > sync_diff.txt 2>/dev/null || echo -n '' > sync_diff.txt
          echo "Diff lines: $(wc -l < sync_diff.txt)"

      - name: Upsert template sync preview comment on PR
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
          REPOS: ${{ steps.config.outputs.repos_list }}
          COUNT: ${{ steps.files.outputs.count }}
          FILES_LIST: files_to_sync.txt
          DIFF_FILE: sync_diff.txt
        run: bash .github/scripts/template-sync-pr-comment.sh "${{ github.event.pull_request.number }}"

      - name: Sync to dependents and open PR
        if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.config.outputs.repos_list != '' && steps.files.outputs.count != '0'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          ORG: ${{ github.repository_owner }}
          BRANCH: chore/template-sync
          REPOS_LIST: ${{ steps.config.outputs.repos_list }}
          FILES_LIST_TEMPLATE: files_to_sync_%s.txt
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run && '1' || '' }}
          DRAFT_PR: ${{ github.event_name == 'workflow_dispatch' && inputs.draft_pr && '1' || '' }}
        run: bash .github/scripts/template-sync-push-pr.sh
